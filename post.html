<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zarrin - Post Details</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Raleway:wght@700&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>
  <body>
    <header class="navbar">
      <div class="container">
        <a href="index.html" class="logo">
          <img src="assets/img/logo.png" alt="Zarrin Logo Icon" />
          <span>Zarrin</span>
        </a>

        <nav class="nav-links">
          <ul class="nav-menu">
            <li><a href="blog.html">Blog</a></li>
            <li><a href="#">About</a></li>
          </ul>
          <a href="#" class="search-icon">
            <i class="fas fa-search"></i>
          </a>
          <a href="#" class="btn btn-primary">Contact Us</a>
        </nav>

        <button class="menu-toggle" aria-label="Open menu">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            fill="currentColor"
            viewBox="0 0 16 16"
          >
            <path
              fill-rule="evenodd"
              d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"
            />
          </svg>
        </button>
      </div>
    </header>

    <main>
      <section class="post-article">
        <div class="container" id="article-container">
          <div style="text-align: center; padding: 50px">
            <h2>Loading article...</h2>
          </div>
        </div>
      </section>

      <section class="blog-section container">
        <div class="section-header">
          <h2>Popular Post</h2>
          <a href="blog.html" class="btn btn-primary">View All</a>
        </div>

        <div class="popular-posts-grid" id="related-posts"></div>
      </section>
    </main>

    <footer>
      <section class="cta-section">
        <div class="container">
          <h2>Get our stories delivered From us to your inbox weekly.</h2>

          <form class="cta-form">
            <input type="email" placeholder="Your Email" required />
            <button type="submit" class="btn btn-secondary-white">
              Get started
            </button>
          </form>

          <p class="cta-helper-text">
            Get a response tomorrow if you submit by 9pm today. If we received
            after 9pm will get a reponse the following day.
          </p>
        </div>
      </section>

      <div class="footer-main">
        <div class="container">
          <a href="index.html" class="logo">
            <img src="assets/img/logo.png" alt="Zarrin Logo Icon" />
            <span>Zarrin</span>
          </a>

          <nav class="footer-nav">
            <ul>
              <li><a href="index.html">Home</a></li>
              <li><a href="blog.html">Blog</a></li>
              <li><a href="#">About</a></li>
              <li><a href="#">Contact Us</a></li>
            </ul>
          </nav>

          <div class="social-links">
            <a href="#" aria-label="Facebook">FB</a>
            <a href="#" aria-label="Instagram">IG</a>
            <a href="#" aria-label="LinkedIn">LN</a>
            <a href="#" aria-label="Youtube">YT</a>
          </div>
        </div>
      </div>

      <div class="footer-copyright">
        <div class="container">
          <p>Copyright Ideapeel Inc © 2023. All Right Reserved</p>
        </div>
      </div>
    </footer>

    <script type="module">
      import axios from "https://cdn.jsdelivr.net/npm/axios@1.7.7/+esm";

      // 1. Cấu hình API
      const api = axios.create({
        baseURL: "http://localhost:4000",
        timeout: 5000,
      });

      // 2. Các hàm tiện ích (Helper)
      const $ = (selector) => document.querySelector(selector);

      const fmtDate = (isoString) => {
        if (!isoString) return "";
        return new Date(isoString).toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
      };

      function escapeHtml(str = "") {
        return str.replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      // Template hiển thị nội dung chi tiết bài viết
      function renderArticle(post) {
        const dummyContent = `
            <p style="font-weight: bold; font-size: 1.1em; color: #333;">
                ${escapeHtml(post.excerpt)}
            </p>
            <p>
                Google has been investing in AI for many years and bringing its
                benefits to individuals, businesses and communities. Whether it’s
                publishing state-of-the-art research, building helpful products or
                developing tools and resources that enable others, we’re committed
                to making AI accessible to everyone.
            </p>
            <blockquote>
                <p>“People worry that computers will get too smart and take over the world, but the real problem is that they’re too stupid and they’ve already taken over the world.”</p>
                <cite>— Pedro Domingos</cite>
            </blockquote>
            <p>
                We’re so excited by the potential of generative AI, and the
                opportunities it will unlock – from helping people express
                themselves creatively, to helping developers build new types of
                applications.
            </p>
        `;

        return `
          <header class="post-header">
            <div class="post-meta">
              <span class="post-category">${escapeHtml(
                post.category || "General"
              )}</span>
              <span class="post-date">${fmtDate(post.date)}</span>
            </div>
            <h1>${escapeHtml(post.title)}</h1>
          </header>

          <figure class="post-featured-image">
            <img src="${post.coverUrl}" alt="${escapeHtml(post.title)}" />
          </figure>

          <article class="post-content">
            ${dummyContent}
          </article>
        `;
      }

      // Template thẻ bài viết nhỏ (cho phần Popular)
      function tplCard(post) {
        return `
        <div class="post-card">
          <div class="card-image">
            <img src="${post.coverUrl}" alt="${escapeHtml(post.title)}" />
          </div>
          <div class="post-card-content">
            <div class="post-meta">
              <span class="post-category">${escapeHtml(
                post.category || ""
              )}</span>
              <span class="post-date">${fmtDate(post.date)}</span>
            </div>
            <h3 class="post-title">${escapeHtml(post.title)}</h3>
            <p class="post-excerpt">${escapeHtml(post.excerpt || "")}</p>
            <a href="post.html?id=${
              post.id
            }" class="post-read-more">Read more...</a>
          </div>
        </div>`;
      }

      // 3. Logic chính
      async function initPostPage() {
        // Lấy ID từ URL (?id=1)
        const params = new URLSearchParams(window.location.search);
        const postId = params.get("id");
        const container = $("#article-container");
        const relatedContainer = $("#related-posts");

        // Nếu không có ID, quay về trang chủ hoặc báo lỗi
        if (!postId) {
          container.innerHTML =
            "<h2>Post not found. <a href='index.html'>Go Home</a></h2>";
          return;
        }

        try {
          // --- Bước 1: Lấy chi tiết bài viết ---
          const { data: post } = await api.get(`/posts/${postId}`);

          // Cập nhật tiêu đề tab trình duyệt
          document.title = `${post.title} - Zarrin`;

          // Render bài viết
          container.innerHTML = renderArticle(post);

          // --- Bước 2: Lấy bài viết liên quan (Popular) ---
          const { data: relatedPosts } = await api.get(
            `/posts?id_ne=${postId}&_limit=3`
          );

          if (relatedPosts.length > 0) {
            relatedContainer.innerHTML = relatedPosts.map(tplCard).join("");
          } else {
            relatedContainer.innerHTML = "<p>No related posts found.</p>";
          }
        } catch (error) {
          console.error("Error:", error);
          container.innerHTML = `<h2>Error loading post. Please try again later. <br> <small>${error.message}</small></h2>`;
        }
      }
      initPostPage();
    </script>
  </body>
</html>
